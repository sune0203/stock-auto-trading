<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOAR Trading System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: white;
            padding: 20px 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        h1 {
            color: #667eea;
            font-size: 32px;
            margin-bottom: 5px;
        }

        .subtitle {
            color: #999;
            font-size: 14px;
        }

        .status-bar {
            background: white;
            padding: 15px 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #10b981;
            animation: pulse 2s infinite;
        }

        .status-dot.closed {
            background: #ef4444;
            animation: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .controls {
            background: white;
            padding: 20px 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
        }

        button:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
        }

        .scan-results-container {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #f0f0f0;
        }

        th {
            background: #f8f9fa;
            color: #667eea;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .score {
            font-weight: 600;
            font-size: 16px;
        }

        .score.high {
            color: #10b981;
        }

        .score.medium {
            color: #f59e0b;
        }

        .score.low {
            color: #ef4444;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge.success {
            background: #d1fae5;
            color: #065f46;
        }

        .badge.warning {
            background: #fef3c7;
            color: #92400e;
        }

        .badge.error {
            background: #fee2e2;
            color: #991b1b;
        }

        .price-change {
            font-weight: 600;
            font-size: 14px;
        }

        .price-change.positive {
            color: #10b981;
        }

        .price-change.negative {
            color: #ef4444;
        }

        .price-change.neutral {
            color: #6b7280;
        }

        .live-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10b981;
            animation: pulse 2s infinite;
            margin-right: 5px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        input, select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ“ˆ SOAR Trading System</h1>
            <p class="subtitle">Smart Opportunity Analysis & Rapid Trading System</p>
        </header>

        <div class="status-bar">
            <div class="status-item">
                <div class="status-dot" id="marketStatusDot"></div>
                <span id="marketStatus">ì‹œì¥ ìƒíƒœ í™•ì¸ ì¤‘...</span>
            </div>
            <div class="status-item">
                <div class="status-dot"></div>
                <span id="autoScanStatus">ğŸ”„ ìë™ ìŠ¤ìº”: í™œì„±í™” (60ì´ˆë§ˆë‹¤)</span>
            </div>
            <div class="status-item">
                <span id="lastUpdate">ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: -</span>
            </div>
        </div>

        <div class="controls">
            <button onclick="runManualScan()" id="scanBtn">ğŸ” ìˆ˜ë™ ìŠ¤ìº”</button>
            <button onclick="refreshResults()" id="refreshBtn">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
            <button onclick="clearAllData()" id="clearBtn" style="background: #dc3545;">ğŸ—‘ï¸ ë°ì´í„° ì´ˆê¸°í™”</button>
            <select id="exchangeSelect">
                <option value="NAS">NASDAQ</option>
                <option value="NYS">NYSE</option>
                <option value="AMS">AMEX</option>
            </select>
            <input type="number" id="maxSymbols" placeholder="ìµœëŒ€ ì¢…ëª© ìˆ˜" value="20" min="10" max="100">
            <span style="color: #666; font-size: 0.9em; margin-left: 10px;">â€» ìë™ ìŠ¤ìº”ì´ 1ë¶„ë§ˆë‹¤ ì‹¤í–‰ë˜ë©°, ê¸°ì¡´ ë°ì´í„°ëŠ” ìœ ì§€ë©ë‹ˆë‹¤</span>
        </div>

        <div class="cards-grid">
            <div class="card">
                <div class="card-title">ğŸ“Š ì‹œìŠ¤í…œ ìƒíƒœ</div>
                <div id="systemStatus">ë¡œë”© ì¤‘...</div>
            </div>
            <div class="card">
                <div class="card-title">âš™ï¸ ì„¤ì •</div>
                <div id="configInfo">ë¡œë”© ì¤‘...</div>
            </div>
            <div class="card">
                <div class="card-title">ğŸ“ˆ íŠ¸ë Œë”© ë‰´ìŠ¤</div>
                <div id="trendingNews">ë¡œë”© ì¤‘...</div>
            </div>
        </div>

        <div class="scan-results-container">
            <div class="card-title">ğŸ¯ ìŠ¤ìº” ê²°ê³¼</div>
            <div id="scanResults" class="empty-state">
                <div class="empty-state-icon">ğŸ“­</div>
                <p>ìŠ¤ìº” ë²„íŠ¼ì„ ëˆŒëŸ¬ ê¸‰ë“±ì£¼ë¥¼ ê²€ìƒ‰í•˜ì„¸ìš”</p>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000/api';
        
        // ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¼
        let realtimeStream = null;
        let scanResults = {};  // ì‹¬ë³¼ë³„ë¡œ ì €ì¥
        
        // localStorage í‚¤
        const STORAGE_KEY = 'soar_scan_results';

        // ì´ˆê¸° ë¡œë“œ
        window.onload = function() {
            // localStorageì—ì„œ ê¸°ì¡´ ë°ì´í„° ë³µì›
            loadFromLocalStorage();
            
            checkHealth();
            loadConfig();
            loadTrendingNews();
            
            // ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¼ ìë™ ì—°ê²°
            connectRealtimeStream();
            
            // ê¸°ì¡´ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ê°€ê²© ì—…ë°ì´íŠ¸ ì‹œì‘
            if (Object.keys(scanResults).length > 0) {
                startPriceUpdate();
            }
        };
        
        // localStorageì—ì„œ ë°ì´í„° ë¡œë“œ
        function loadFromLocalStorage() {
            try {
                const stored = localStorage.getItem(STORAGE_KEY);
                if (stored) {
                    scanResults = JSON.parse(stored);
                    console.log(`ğŸ’¾ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ${Object.keys(scanResults).length}ê°œ ì¢…ëª© ë³µì›`);
                    displayResults();
                }
            } catch (e) {
                console.error('ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ë¡œë“œ ì‹¤íŒ¨:', e);
            }
        }
        
        // localStorageì— ë°ì´í„° ì €ì¥
        function saveToLocalStorage() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(scanResults));
            } catch (e) {
                console.error('ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì €ì¥ ì‹¤íŒ¨:', e);
            }
        }

        // ê°€ê²© ì—…ë°ì´íŠ¸ (í”„ë¡ íŠ¸ ì£¼ë„)
        let priceUpdateInterval = null;
        
        function startPriceUpdate() {
            // ê¸°ì¡´ ì¸í„°ë²Œ ì •ë¦¬
            if (priceUpdateInterval) {
                clearInterval(priceUpdateInterval);
            }
            
            // 3ì´ˆë§ˆë‹¤ ê°€ê²© ì—…ë°ì´íŠ¸
            priceUpdateInterval = setInterval(async () => {
                const symbols = Object.keys(scanResults);
                
                if (symbols.length === 0) {
                    return;
                }
                
                try {
                    const response = await fetch(`${API_BASE}/quotes/batch`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(symbols)
                    });
                    
                    const data = await response.json();
                    
                    if (data.status === 'success') {
                        // ê°€ê²© ì—…ë°ì´íŠ¸
                        data.quotes.forEach(quote => {
                            const symbol = quote.symbol;
                            if (scanResults[symbol]) {
                                const discoveredPrice = scanResults[symbol].discovered_price || quote.price;
                                const currentPrice = quote.price || 0;
                                
                                // ë³€í™”ìœ¨ ê³„ì‚°
                                let priceChangePct = 0;
                                if (discoveredPrice > 0) {
                                    priceChangePct = ((currentPrice - discoveredPrice) / discoveredPrice) * 100;
                                }
                                
                                // ë°ì´í„° ì—…ë°ì´íŠ¸
                                scanResults[symbol].realtime_price = currentPrice;
                                scanResults[symbol].price_change_pct = priceChangePct;
                                scanResults[symbol].last_updated = new Date().toISOString();
                            }
                        });
                        
                        // í™”ë©´ ê°±ì‹ 
                        displayResults();
                        
                        // ì£¼ê¸°ì  ì €ì¥ (10ì´ˆë§ˆë‹¤)
                        if (!window.lastSaveTime || Date.now() - window.lastSaveTime > 10000) {
                            saveToLocalStorage();
                            window.lastSaveTime = Date.now();
                        }
                    }
                } catch (error) {
                    console.error('ê°€ê²© ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
                }
            }, 3000);  // 3ì´ˆë§ˆë‹¤
        }
        
        function stopPriceUpdate() {
            if (priceUpdateInterval) {
                clearInterval(priceUpdateInterval);
                priceUpdateInterval = null;
            }
        }

        // í—¬ìŠ¤ ì²´í¬
        async function checkHealth() {
            try {
                // ì‹œìŠ¤í…œ í—¬ìŠ¤ ì²´í¬
                const healthResponse = await fetch(`${API_BASE}/health`);
                const healthData = await healthResponse.json();

                const statusHtml = `
                    <p>âœ… KIS API: ${healthData.kis_connected ? 'ì—°ê²°ë¨' : 'ë¯¸ì—°ê²°'}</p>
                    <p>âœ… FMP API: ${healthData.fmp_connected ? 'ì—°ê²°ë¨' : 'ë¯¸ì—°ê²°'}</p>
                    <p>âœ… Database: ${healthData.db_connected ? 'ì—°ê²°ë¨' : 'ë¯¸ì—°ê²°'}</p>
                `;
                document.getElementById('systemStatus').innerHTML = statusHtml;

                // ì‹œì¥ ì„¸ì…˜ ì •ë³´ ì¡°íšŒ
                const sessionResponse = await fetch(`${API_BASE}/market/session`);
                const sessionData = await sessionResponse.json();

                const marketDot = document.getElementById('marketStatusDot');
                const marketStatus = document.getElementById('marketStatus');

                // ì„¸ì…˜ë³„ ì•„ì´ì½˜
                const sessionIcons = {
                    'RTH': 'ğŸ“ˆ',      // ì •ê·œì¥
                    'PRE': 'ğŸŒ…',      // í”„ë¦¬ë§ˆì¼“
                    'AFTER': 'ğŸŒ™',    // ì• í”„í„°ë§ˆì¼“
                    'CLOSED': 'ğŸ”´'    // ì¥ë§ˆê°
                };

                const icon = sessionIcons[sessionData.session] || 'â“';
                
                if (sessionData.is_trading) {
                    marketDot.classList.remove('closed');
                    marketStatus.textContent = `${icon} ${sessionData.session_name} (ì„œë¨¸íƒ€ì„: ${sessionData.is_dst ? 'ì ìš©' : 'ë¯¸ì ìš©'})`;
                } else {
                    marketDot.classList.add('closed');
                    marketStatus.textContent = `${icon} ${sessionData.session_name} - ${sessionData.next_open}`;
                }

            } catch (error) {
                console.error('Health check failed:', error);
                document.getElementById('systemStatus').innerHTML = '<p style="color: red;">âŒ ì„œë²„ ì—°ê²° ì‹¤íŒ¨</p>';
            }
        }

        // ì„¤ì • ë¡œë“œ
        async function loadConfig() {
            try {
                const response = await fetch(`${API_BASE}/config`);
                const data = await response.json();

                const configHtml = `
                    <p><strong>ìµœì†Œ ì§„ì… ì ìˆ˜:</strong> ${data.trading.min_score}</p>
                    <p><strong>ìµœëŒ€ í¬ì§€ì…˜:</strong> ${data.trading.max_position_size * 100}%</p>
                    <p><strong>ì†ì ˆ:</strong> ${data.trading.fixed_stop_loss_percent}%</p>
                    <p><strong>ìŠ¤ìº” ì£¼ê¸°:</strong> ${data.scanner.scan_interval}ì´ˆ</p>
                `;
                document.getElementById('configInfo').innerHTML = configHtml;

            } catch (error) {
                console.error('Config load failed:', error);
            }
        }

        // íŠ¸ë Œë”© ë‰´ìŠ¤ ë¡œë“œ
        async function loadTrendingNews() {
            try {
                const response = await fetch(`${API_BASE}/news/trending?hours=6`);
                const data = await response.json();

                if (data.news && data.news.length > 0) {
                    const newsHtml = data.news.slice(0, 5).map(news => `
                        <p style="margin: 10px 0;">
                            <strong>${news.n_ticker}</strong>: ${news.n_title_kr.substring(0, 50)}...
                            <span class="badge ${news.n_grade === 'A' ? 'success' : 'warning'}">${news.n_grade}</span>
                        </p>
                    `).join('');
                    document.getElementById('trendingNews').innerHTML = newsHtml;
                } else {
                    document.getElementById('trendingNews').innerHTML = '<p>íŠ¸ë Œë”© ë‰´ìŠ¤ ì—†ìŒ</p>';
                }

            } catch (error) {
                console.error('News load failed:', error);
            }
        }
        
        // ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¼ ì—°ê²° (ìë™ ê°±ì‹ )
        function connectRealtimeStream() {
            console.log('ğŸ“¡ ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¼ ì—°ê²° ì¤‘...');
            
            // ê¸°ì¡´ ì—°ê²° ë‹«ê¸°
            if (realtimeStream) {
                realtimeStream.close();
            }
            
            // EventSourceë¡œ SSE ì—°ê²°
            realtimeStream = new EventSource(`${API_BASE}/realtime/stream`);
            
            realtimeStream.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    handleRealtimeUpdate(data);
                } catch (e) {
                    console.error('ì‹¤ì‹œê°„ ë°ì´í„° íŒŒì‹± ì˜¤ë¥˜:', e);
                }
            };
            
            realtimeStream.onerror = function(error) {
                console.error('ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¼ ì˜¤ë¥˜:', error);
                console.log('5ì´ˆ í›„ ì¬ì—°ê²° ì‹œë„...');
                
                if (realtimeStream) {
                    realtimeStream.close();
                }
                
                // 5ì´ˆ í›„ ì¬ì—°ê²°
                setTimeout(connectRealtimeStream, 5000);
            };
            
            console.log('âœ… ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¼ ì—°ê²°ë¨');
        }
        
        // ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ì²˜ë¦¬
        function handleRealtimeUpdate(data) {
            switch(data.type) {
                case 'initial_data':
                    // ì´ˆê¸° ë°ì´í„° ë¡œë“œ (ê¸°ì¡´ ë°ì´í„°ì™€ ë³‘í•©)
                    console.log(`ğŸ“Š ì´ˆê¸° ë°ì´í„° ìˆ˜ì‹ : ${data.count}ê°œ ì¢…ëª©`);
                    data.results.forEach(result => {
                        scanResults[result.symbol] = result;
                    });
                    saveToLocalStorage();
                    displayResults();
                    updateLastUpdate();
                    
                    // ê°€ê²© ì—…ë°ì´íŠ¸ ì‹œì‘
                    if (Object.keys(scanResults).length > 0) {
                        startPriceUpdate();
                    }
                    break;
                
                case 'symbol_update':
                    // ë‹¨ì¼ ì¢…ëª© ì™„ë£Œ (ì¦‰ì‹œ ì—…ë°ì´íŠ¸)
                    const symbol = data.symbol;
                    scanResults[symbol] = data.data;
                    console.log(`âœ… ${symbol} ì—…ë°ì´íŠ¸ (ì ìˆ˜: ${data.data.total_score.toFixed(1)})`);
                    saveToLocalStorage();
                    displayResults();
                    updateLastUpdate();
                    
                    // ì²« ì¢…ëª© ì¶”ê°€ ì‹œ ê°€ê²© ì—…ë°ì´íŠ¸ ì‹œì‘
                    if (Object.keys(scanResults).length === 1) {
                        startPriceUpdate();
                    }
                    break;
                
                case 'scan_update':
                    // ìŠ¤ìº” ì™„ë£Œ ì—…ë°ì´íŠ¸ (ê¸°ì¡´ ë°ì´í„° ìœ ì§€í•˜ë©° ì—…ë°ì´íŠ¸)
                    console.log(`ğŸ”„ ìŠ¤ìº” ì—…ë°ì´íŠ¸: ${data.count}ê°œ ì¢…ëª© (ê¸°ì¡´ ${Object.keys(scanResults).length}ê°œ ìœ ì§€)`);
                    data.results.forEach(result => {
                        scanResults[result.symbol] = result;
                    });
                    saveToLocalStorage();
                    displayResults();
                    updateLastUpdate();
                    break;
                
                case 'price_update':
                    // ê°€ê²© ì—…ë°ì´íŠ¸ (ì¬í‰ê°€ í¬í•¨)
                    console.log(`ğŸ“ˆ ê°€ê²© ì—…ë°ì´íŠ¸: ${data.count}ê°œ ì¢…ëª©`);
                    data.results.forEach(result => {
                        scanResults[result.symbol] = result;
                    });
                    saveToLocalStorage();
                    displayResults();
                    updateLastUpdate();
                    break;
                
                case 'heartbeat':
                    // í•˜íŠ¸ë¹„íŠ¸ (ì—°ê²° ìœ ì§€)
                    break;
                
                case 'error':
                    console.error('ì„œë²„ ì˜¤ë¥˜:', data.message);
                    break;
            }
        }

        // ìˆ˜ë™ ìŠ¤ìº” (ì¶”ê°€ ìŠ¤ìº” ìš”ì²­)
        async function runManualScan() {
            const scanBtn = document.getElementById('scanBtn');
            const refreshBtn = document.getElementById('refreshBtn');
            const exchange = document.getElementById('exchangeSelect').value;
            const maxSymbols = document.getElementById('maxSymbols').value;

            scanBtn.disabled = true;
            refreshBtn.disabled = true;
            scanBtn.textContent = 'â³ ìŠ¤ìº” ì¤‘...';

            try {
                // ìˆ˜ë™ ìŠ¤ìº” ìš”ì²­
                const response = await fetch(`${API_BASE}/scan?exchange=${exchange}&max_symbols=${maxSymbols}`, {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.status === 'scanning') {
                    console.log('âœ… ìˆ˜ë™ ìŠ¤ìº” ì‹œì‘ë¨');
                    // ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¼ì„ í†µí•´ ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë¨
                } else {
                    throw new Error('ìŠ¤ìº” ì‹œì‘ ì‹¤íŒ¨');
                }

            } catch (error) {
                console.error('ìˆ˜ë™ ìŠ¤ìº” ì‹¤íŒ¨:', error);
                alert(`ìŠ¤ìº” ì‹¤íŒ¨: ${error.message}`);
            } finally {
                scanBtn.disabled = false;
                refreshBtn.disabled = false;
                scanBtn.textContent = 'ğŸ” ìˆ˜ë™ ìŠ¤ìº”';
            }
        }

        // ê²°ê³¼ ìƒˆë¡œê³ ì¹¨
        async function refreshResults() {
            console.log('ğŸ”„ ê²°ê³¼ ìƒˆë¡œê³ ì¹¨...');
            // ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¼ì´ ìë™ìœ¼ë¡œ ìµœì‹  ë°ì´í„°ë¥¼ í‘¸ì‹œí•˜ë¯€ë¡œ ë³„ë„ ì‘ì—… ë¶ˆí•„ìš”
            // í•„ìš”ì‹œ ìŠ¤íŠ¸ë¦¼ ì¬ì—°ê²°
            connectRealtimeStream();
        }
        
        // ëª¨ë“  ë°ì´í„° ì´ˆê¸°í™”
        function clearAllData() {
            if (!confirm('âš ï¸ ëª¨ë“  ìŠ¤ìº” ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ìƒˆë¡œìš´ ìŠ¤ìº” ë°ì´í„°ëŠ” ê³„ì† ìˆ˜ì‹ ë©ë‹ˆë‹¤)')) {
                return;
            }
            
            // ê°€ê²© ì—…ë°ì´íŠ¸ ì¤‘ì§€
            stopPriceUpdate();
            
            // ë©”ëª¨ë¦¬ ë° localStorage ì´ˆê¸°í™”
            scanResults = {};
            localStorage.removeItem(STORAGE_KEY);
            
            // í™”ë©´ ì—…ë°ì´íŠ¸
            displayResults();
            
            console.log('ğŸ—‘ï¸ ëª¨ë“  ë°ì´í„° ì´ˆê¸°í™” ì™„ë£Œ');
            alert('âœ… ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.\nìë™ ìŠ¤ìº”ì´ ê³„ì† ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤.');
        }

        // ê²°ê³¼ í‘œì‹œ (ì‹¤ì „ íŠ¸ë ˆì´ë”© ì •ë³´ ì¤‘ì‹¬)
        function displayResults() {
            // scanResults ê°ì²´ë¥¼ ë°°ì—´ë¡œ ë³€í™˜í•˜ê³  ì ìˆ˜ìˆœ ì •ë ¬
            const resultsArray = Object.values(scanResults).sort((a, b) => 
                b.total_score - a.total_score
            ).slice(0, 20);  // ìƒìœ„ 20ê°œë§Œ
            
            if (resultsArray.length === 0) {
                document.getElementById('scanResults').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“­</div>
                        <p>ìŠ¤ìº” ê²°ê³¼ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...</p>
                        <p style="font-size: 0.9em; color: #666; margin-top: 10px;">ìë™ ìŠ¤ìº”ì´ 1ë¶„ë§ˆë‹¤ ì‹¤í–‰ë©ë‹ˆë‹¤</p>
                    </div>
                `;
                return;
            }
            
            const results = resultsArray;

            const tableHtml = `
                <table id="resultsTable" style="font-size: 0.95em;">
                    <thead>
                        <tr>
                            <th>ìˆœìœ„</th>
                            <th>ì‹¬ë³¼</th>
                            <th>ì‹ í˜¸</th>
                            <th>í˜„ì¬ê°€<br/>(ë³€í™”ìœ¨)</th>
                            <th>ë°œê²¬ê°€</th>
                            <th>1ì°¨ ìµì ˆ<br/>(ëª©í‘œ)</th>
                            <th>ì†ì ˆê°€</th>
                            <th>ë¦¬ìŠ¤í¬/<br/>ë¦¬ì›Œë“œ</th>
                            <th>í¬ì§€ì…˜<br/>(ê³„ì¢Œ%)</th>
                            <th>ë¦¬ìŠ¤í¬</th>
                            <th>ì•¡ì…˜</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${results.map((item, index) => {
                            const plan = item.trading_plan || {};
                            
                            // ì‹ í˜¸ ì•„ì´ì½˜ ë° ìƒ‰ìƒ
                            let signalIcon, signalColor, signalText;
                            if (plan.signal === 'BUY') {
                                signalIcon = 'ğŸ’°';
                                signalColor = 'green';
                                signalText = 'BUY';
                            } else if (plan.signal === 'SELL') {
                                signalIcon = 'âš ï¸';
                                signalColor = 'red';
                                signalText = 'SELL';
                            } else {
                                signalIcon = 'â¸ï¸';
                                signalColor = 'gray';
                                signalText = 'HOLD';
                            }
                            
                            // ì‹¤ì‹œê°„ ê°€ê²© ì •ë³´ (ì¬í‰ê°€ëœ ë°ì´í„° ì‚¬ìš©)
                            const currentPrice = item.realtime_price || plan.current_price || '-';
                            const discoveredPrice = item.discovered_price || plan.entry_price || currentPrice;
                            
                            // ë°œê²¬ ì´í›„ ë³€í™”ìœ¨
                            const priceChangePct = item.price_change_pct || 0;
                            const priceClass = priceChangePct > 0 ? 'positive' : priceChangePct < 0 ? 'negative' : 'neutral';
                            
                            // ë¦¬ìŠ¤í¬ ë ˆë²¨ ìƒ‰ìƒ
                            const riskColorMap = {
                                'low': 'green',
                                'medium': 'orange',
                                'high': 'red'
                            };
                            const riskColor = riskColorMap[plan.risk_level] || 'gray';
                            
                            return `
                                <tr data-symbol="${item.symbol}" style="border-bottom: 1px solid #eee;">
                                    <td style="text-align: center;">${index + 1}</td>
                                    <td><strong style="font-size: 1.1em;">${item.symbol}</strong></td>
                                    <td style="text-align: center;">
                                        <div style="background: ${signalColor}; color: white; padding: 5px 10px; border-radius: 5px; font-weight: bold;">
                                            ${signalIcon} ${signalText}
                                        </div>
                                    </td>
                                    <td class="live-price" data-symbol="${item.symbol}" style="text-align: right;">
                                        <strong style="font-size: 1.1em;">$${typeof currentPrice === 'number' ? currentPrice.toFixed(2) : currentPrice}</strong>
                                        <br/>
                                        <small class="price-change ${priceClass}" style="font-weight: bold;">
                                            ${priceChangePct > 0 ? '+' : ''}${priceChangePct.toFixed(2)}%
                                        </small>
                                    </td>
                                    <td style="text-align: right; color: #666;">
                                        <strong>$${typeof discoveredPrice === 'number' ? discoveredPrice.toFixed(2) : discoveredPrice}</strong>
                                        <br/>
                                        <small style="color: #999;">(ë°œê²¬ê°€)</small>
                                    </td>
                                    <td style="text-align: right; color: green;">
                                        <strong>$${plan.targets ? plan.targets.target1.toFixed(2) : '-'}</strong>
                                        <br/>
                                        <small>(+${plan.targets ? plan.targets.target1_pct.toFixed(1) : '-'}%)</small>
                                    </td>
                                    <td style="text-align: right; color: red;">
                                        <strong>$${plan.stop_loss ? plan.stop_loss.toFixed(2) : '-'}</strong>
                                        <br/>
                                        <small>(-${plan.stop_loss_pct ? plan.stop_loss_pct.toFixed(1) : '-'}%)</small>
                                    </td>
                                    <td style="text-align: center;">
                                        <span style="background: ${plan.risk_reward_ratio >= 3 ? '#28a745' : plan.risk_reward_ratio >= 2 ? '#ffc107' : '#dc3545'}; color: white; padding: 3px 8px; border-radius: 3px; font-weight: bold;">
                                            ${plan.risk_reward_ratio ? plan.risk_reward_ratio.toFixed(1) : '-'}:1
                                        </span>
                                    </td>
                                    <td style="text-align: center;">
                                        <strong style="font-size: 1.1em;">${plan.position_size_pct ? plan.position_size_pct.toFixed(1) : '-'}%</strong>
                                        <br/>
                                        <small style="color: #666;">${plan.holding_period || '-'}</small>
                                    </td>
                                    <td style="text-align: center;">
                                        <span style="background: ${riskColor}; color: white; padding: 3px 8px; border-radius: 3px;">
                                            ${plan.risk_level ? plan.risk_level.toUpperCase() : '-'}
                                        </span>
                                    </td>
                                    <td style="font-size: 0.85em; max-width: 200px;">
                                        ${plan.action_summary || 'ë¶„ì„ ì¤‘...'}
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
                
                <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px;">
                    <h4 style="margin-top: 0;">ğŸ“Š íŠ¸ë ˆì´ë”© ê°€ì´ë“œ</h4>
                    <ul style="margin: 0; padding-left: 20px; line-height: 1.8;">
                        <li><strong>ì‹ í˜¸</strong>: ğŸ’° BUY = ë§¤ìˆ˜ ì¶”ì²œ, â¸ï¸ HOLD = ëŒ€ê¸°, âš ï¸ SELL = ë§¤ë„</li>
                        <li><strong>ì§„ì…ê°€</strong>: ì¶”ì²œ ë§¤ìˆ˜ ê°€ê²© (VWAP ê³ ë ¤)</li>
                        <li><strong>1ì°¨ ìµì ˆ</strong>: ìˆ˜ìµ ì‹¤í˜„ ëª©í‘œ (2ì°¨: +${results[0]?.trading_plan?.targets?.target2_pct?.toFixed(1) || 0}%, 3ì°¨: +${results[0]?.trading_plan?.targets?.target3_pct?.toFixed(1) || 0}%)</li>
                        <li><strong>ì†ì ˆê°€</strong>: ì†ì‹¤ ì œí•œ ê°€ê²©</li>
                        <li><strong>ë¦¬ìŠ¤í¬/ë¦¬ì›Œë“œ</strong>: 3:1 ì´ìƒ ê¶Œì¥</li>
                        <li><strong>í¬ì§€ì…˜</strong>: ê³„ì¢Œ ìì‚° ëŒ€ë¹„ íˆ¬ì ë¹„ìœ¨ ê¶Œì¥ì¹˜</li>
                        <li><strong>ë¦¬ìŠ¤í¬</strong>: LOW = ì•ˆì „, MEDIUM = ë³´í†µ, HIGH = ìœ„í—˜</li>
                    </ul>
                </div>
            `;

            document.getElementById('scanResults').innerHTML = tableHtml;
        }

        // ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ ì‹œê°„ ê°±ì‹ 
        function updateLastUpdate() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('ko-KR');
            document.getElementById('lastUpdate').textContent = `ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ${timeStr}`;
        }

        // í˜ì´ì§€ ì¢…ë£Œ ì‹œ ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¼ ë‹«ê¸°
        window.onbeforeunload = function() {
            if (realtimeStream) {
                realtimeStream.close();
            }
        };
        
        // 5ë¶„ë§ˆë‹¤ ìë™ í—¬ìŠ¤ ì²´í¬
        setInterval(checkHealth, 300000);
    </script>
</body>
</html>

